---
layout: post
title: Patchadd -R and KU Patches After 137137 (aka newboot on SPARC)
date: 1969-12-31 16:00:00.000000000 -08:00
tags: []
type: post
published: true
---
<p>With the introduction of the new boot architecture on Solaris SPARC (Solaris 10 10/08 / KU 137137)  came some consistency: SPARC's boot architecture now uses the same boot archive method Solaris 10 x86 has been using since the <a href="http://www.sun.com/bigadmin/features/articles/grub_boot_faq.jsp">change introduced in Solaris 10 1/06</a>, just without the need for GRUB.</p>
<p>Sadly this brought in a relatively significant change to patching inactive boot disks in a SPARC environment that people weren't expecting, and it's not actually documented anywhere. (I guess the x86 uptake isn't quite so significant yet as this has been around for a long time in the x86 world).</p>
<p>With the new boot architecture, come the boot archive.  This boot archive needs to be updated with the current kernel state, files, configuration etc so the system can boot the next time off this boot image.  This happens when you gracefully shut the system down.  Now the problem comes in when you patch an inactive boot disk using "<code>patchadd -R /
<path /></code>" or "<code>install_cluster -R /
<path /></code>", this doesn't happen so when you come to boot off your newly patched boot disk, you're likely to encounter something akin to the following:</p>
<div class="terminal">
boot-archive{0} ok boot disk<br />
Boot device: /virtual-devices@100/channel-devices@200/disk@0  File and args:<br />
SunOS Release 5.10 Version Generic_139555-08 64-bit<br />
Copyright 1983-2009 Sun Microsystems, Inc.  All rights reserved.<br />
Use is subject to license terms.<br />
/<br />
WARNING: The following files in / differ from the boot archive:</p>
<p>Hostname: v4v-machine-b15-gmp03<br />
    changed /platform/SUNW,Netra-CP3260/kernel/cpu/sparcv9/generic<br />
    changed /platform/SUNW,Netra-CP3260/kernel/cpu/sparcv9/SUNW,UltraSPARC-T1<br />
    [... TRUNCATED FOR BREVITY ...]<br />
    changed /kernel/kmdb/sparcv9/genunix</p>
<p>The recommended action is to reboot to the failsafe archive to correct<br />
the above inconsistency. To accomplish this, on a GRUB-based platform,<br />
reboot and select the "Solaris failsafe" option from the boot menu.<br />
On an OBP-based platform, reboot then type "boot -F failsafe". Then<br />
follow the prompts to update the boot archive. Alternately, to continue<br />
booting at your own risk, you may clear the service by running:<br />
"svcadm clear system/boot-archive"</p>
<p>Jul  3 16:20:15 svc.startd[7]: svc:/system/boot-archive:default: Method "/lib/svc/method/boot-archive" failed with exit status 95.<br />
Jul  3 16:20:15 svc.startd[7]: system/boot-archive:default failed fatally: transitioned to maintenance (see 'svcs -xv' for details)<br />
Requesting System Maintenance Mode<br />
(See /lib/svc/share/README for more information.)<br />
Console login service(s) cannot run</p>
<p>Root password for system maintenance (control-d to bypass):</p></div>
<p>In order to prevent this from happening, you need to remember to manually update the boot archive on the inactive boot disk.  This can be done using: "<code>/boot/solaris/bin/create_ramdisk -R /
<path /></code>" or "<code>/sbin/bootadm update-archive -R</code>".</p>
<p>A bug has been logged for this change in behaviour...</p>
<p>Bug ID: 6826798<br />
Synopsis: Applying 137137-09 followed by 138888-03 to inactive boot disk creates incorrect<br />
Status: 11-Closed/Will Not Fix</p>
<p>... but it's been closed as will not fix.  I'm not sure exactly why, but from the comments in the bug report, it seems the RPE engineers consider this a "roll-your-own" boot environment maintenance method, and accordingly, it's the sysadmin's responsibility to remember to update the boot archive.</p>
<p>The same thing happens when you patch via jumpstart.  You need to add a command to update the boot archive now too.</p>
<p>---<br />
The issue is that with the introduction of the boot archive introduced in 137137-09, if you add patches after 137137-09, the boot archive needs to be updated. If you are using Live Upgrade, that is done by luactivate, see 6805387 for further details. This CR is about a "roll your own" boot environment maintenance, so that functionality that is performed by the relevant tools needs to be performed manually, in this case, the boot archive needs to be updated manually. See the workaround for the command.<br />
---</p>
<p>Most people don't like being told this, even when you consider this has been the case for on x86 since the newboot architecture was introduced here.</p>
